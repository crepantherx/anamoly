{% extends "base.html" %}

{% block content %}
<!-- Top Bar -->
<header class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center">
    <h2 class="text-xl font-semibold">Live Transaction Monitor</h2>
    <div class="flex items-center space-x-4">
        <select id="model-select"
            class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block w-full p-2.5">
            <option value="isolation_forest">Isolation Forest</option>
            <option value="lof">Local Outlier Factor</option>
            <option value="one_class_svm">One-Class SVM</option>
            <option value="elliptic_envelope">Robust Covariance</option>
        </select>
        <button id="toggle-emulation"
            class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition">
            Start Emulation
        </button>
    </div>
</header>

<!-- Dashboard Content -->
<div class="p-6 space-y-6">

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 shadow-lg">
            <div class="text-gray-400 text-sm uppercase font-semibold">Total Transactions</div>
            <div class="text-3xl font-bold mt-2" id="total-tx">0</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 shadow-lg">
            <div class="text-gray-400 text-sm uppercase font-semibold">Anomalies Detected</div>
            <div class="text-3xl font-bold mt-2 text-red-500" id="total-anomalies">0</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 shadow-lg">
            <div class="text-gray-400 text-sm uppercase font-semibold">Anomaly Rate</div>
            <div class="text-3xl font-bold mt-2 text-yellow-500" id="anomaly-rate">0%</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 shadow-lg lg:col-span-2">
            <h3 class="text-lg font-semibold mb-4">Transaction Stream</h3>
            <div class="relative w-full" style="height: 400px;">
                <canvas id="txChart"></canvas>
            </div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 shadow-lg overflow-hidden flex flex-col"
            style="height: 450px;">
            <h3 class="text-lg font-semibold mb-4">Recent Alerts</h3>
            <div class="overflow-y-auto flex-1" id="alerts-feed">
                <!-- Alerts will be injected here -->
                <div class="text-gray-500 text-sm text-center mt-10">No anomalies yet...</div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // --- State ---
    let isEmulating = false;
    let totalTx = 0;
    let totalAnomalies = 0;

    // --- Chart Setup ---
    const ctx = document.getElementById('txChart').getContext('2d');
    const txChart = new Chart(ctx, {
        type: 'scatter', // Better for discrete events
        data: {
            datasets: [{
                label: 'Normal',
                data: [],
                backgroundColor: '#38b2ac', // Teal 400
                pointRadius: 4,
                pointHoverRadius: 6
            },
            {
                label: 'Anomalies',
                data: [],
                backgroundColor: '#f56565', // Red 500
                pointRadius: 8,
                pointHoverRadius: 10,
                pointStyle: 'rectRot'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'second',
                        displayFormats: {
                            second: 'HH:mm:ss'
                        }
                    },
                    grid: {
                        color: '#2d3748'
                    },
                    ticks: {
                        color: '#a0aec0'
                    },
                    title: {
                        display: true,
                        text: 'Time (UTC)',
                        color: '#718096'
                    }
                },
                y: {
                    grid: {
                        color: '#2d3748'
                    },
                    ticks: {
                        color: '#a0aec0'
                    },
                    title: {
                        display: true,
                        text: 'Transaction Amount ($)',
                        color: '#718096'
                    },
                    suggestedMin: 0,
                    suggestedMax: 1000
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#cbd5e0'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const pt = context.raw;
                            return `User: ${pt.user} | Amt: $${pt.y} | Score: ${pt.score}`;
                        }
                    }
                }
            },
            animation: false
        }
    });

    // --- WebSocket ---
    const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws/dashboard`);

    ws.onmessage = function (event) {
        const data = JSON.parse(event.data);
        updateDashboard(data);
    };

    function updateDashboard(data) {
        // Update Stats
        totalTx++;
        if (data.is_anomaly) totalAnomalies++;

        document.getElementById('total-tx').innerText = totalTx;
        document.getElementById('total-anomalies').innerText = totalAnomalies;
        document.getElementById('anomaly-rate').innerText = ((totalAnomalies / totalTx) * 100).toFixed(2) + '%';

        // Update Chart
        const time = new Date(data.timestamp);
        const point = { x: time, y: data.amount, user: data.user, score: data.score };

        if (data.is_anomaly) {
            txChart.data.datasets[1].data.push(point);
            addAlert(data);
        } else {
            txChart.data.datasets[0].data.push(point);
        }

        // Keep chart window fixed size (e.g., last 50 points total)
        const maxPoints = 50;
        const totalPoints = txChart.data.datasets[0].data.length + txChart.data.datasets[1].data.length;

        if (totalPoints > maxPoints) {
            // Remove oldest
            const d0 = txChart.data.datasets[0].data[0];
            const d1 = txChart.data.datasets[1].data[0];

            if (d0 && d1) {
                if (d0.x < d1.x) txChart.data.datasets[0].data.shift();
                else txChart.data.datasets[1].data.shift();
            } else if (d0) {
                txChart.data.datasets[0].data.shift();
            } else if (d1) {
                txChart.data.datasets[1].data.shift();
            }
        }

        txChart.update();
    }

    function addAlert(data) {
        const feed = document.getElementById('alerts-feed');
        const alertDiv = document.createElement('div');
        alertDiv.className = "bg-red-900/30 border-l-4 border-red-500 p-3 mb-2 rounded animate-pulse";
        alertDiv.innerHTML = `
            <div class="flex justify-between">
                <span class="text-red-400 font-bold">ANOMALY DETECTED</span>
                <span class="text-xs text-gray-400">${new Date(data.timestamp).toLocaleTimeString()}</span>
            </div>
            <div class="text-sm text-gray-300 mt-1">Amount: $${data.amount}</div>
            <div class="text-xs text-gray-500 mt-1">Score: ${data.score} | Loc: ${data.location}</div>
        `;
        feed.prepend(alertDiv);

        // Remove "No anomalies" text if present
        if (feed.children.length > 0 && feed.children[feed.children.length - 1].innerText.includes("No anomalies")) {
            feed.children[feed.children.length - 1].remove();
        }
    }

    // --- Controls ---
    const toggleBtn = document.getElementById('toggle-emulation');
    toggleBtn.addEventListener('click', async () => {
        if (!isEmulating) {
            const res = await fetch('/api/emulation/start', { method: 'POST' });
            const json = await res.json();
            if (json.status === 'started' || json.status === 'already running') {
                isEmulating = true;
                toggleBtn.innerText = "Stop Emulation";
                toggleBtn.classList.replace('bg-teal-600', 'bg-red-600');
                toggleBtn.classList.replace('hover:bg-teal-700', 'hover:bg-red-700');
            }
        } else {
            const res = await fetch('/api/emulation/stop', { method: 'POST' });
            isEmulating = false;
            toggleBtn.innerText = "Start Emulation";
            toggleBtn.classList.replace('bg-red-600', 'bg-teal-600');
            toggleBtn.classList.replace('hover:bg-red-700', 'hover:bg-teal-700');
        }
    });

    const modelSelect = document.getElementById('model-select');
    modelSelect.addEventListener('change', async (e) => {
        const model = e.target.value;
        await fetch(`/api/model/select?model_name=${model}`, { method: 'POST' });
        console.log(`Switched to ${model}`);
    });

    // Initial Stats Load
    async function loadStats() {
        const res = await fetch('/api/stats');
        const data = await res.json();
        totalTx = data.total_transactions;
        totalAnomalies = data.total_anomalies;
        document.getElementById('total-tx').innerText = totalTx;
        document.getElementById('total-anomalies').innerText = totalAnomalies;
        document.getElementById('anomaly-rate').innerText = (data.anomaly_rate * 100).toFixed(2) + '%';
    }
    loadStats();

</script>
{% endblock %}